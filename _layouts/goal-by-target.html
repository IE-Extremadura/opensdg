{% include head.html %}
{% include header.html %}

<div class="container">
    {% include components/goal/breadcrumbs.html %}
</div>

<div class="heading goal-banner goal-{{ page.goal.number }}">
    <div class="container">
        <div class="row">
            <div class="col-xs-4 col-md-3 col-lg-2 goal-tiles">
                <img src="{{ page.goal.icon }}" alt="{{ page.goal.short | escape }} - {{ page.t.general.goal }} {{ page.goal.number }}" id="goal-{{ page.goal.number }}"/>
            </div>
            <div class="col-xs-8 col-md-9 col-lg-10">
                <h1>
                    <span class="hidden-sm hidden-md hidden-lg">{{ page.t.general.goal }}
                        {{ page.goal.number }}:
                    </span>
                    {{ page.goal.name }}
                </h1>
            </div>
        </div>
    </div>
</div>

<div class="container goal-indicators goal-{{ page.goal.number }} goal-by-target" id="main-content">

    {{ content }}

    <div class="visible-md-block visible-lg-block">
        <div class="col-md-4">
            <h2>{{ page.t.general.targets }}</h2>
        </div>
        <div class="col-md-8">
            <h2>{{ page.t.general.indicators }}</h2>
        </div>
    </div>

    {% assign goal_indicators = page.indicators | where: 'goal_number', page.goal.number | group_by: 'target_number' %}
    {% for group in goal_indicators %}
        {% assign target = group.name | sdg_lookup %}
        <div class="indicator-cards target goal-target col-md-4">
            <span>
                <label class="hidden-md hidden-lg">{{ page.t.general.target }}</label>
                {{ target.number }}
            </span>
            {{ target.name }}
        </div>
        <!-- TODO: Escribir una Gema de Ruby para crear filtros custom y mejorar el rendimiento de esto. -->
        <div class="indicator-cards col-md-8 row no-gutters">
            {% for indicator in group.items %}
                <!-- Comprobamos si tiene algún hijo. -->
                {% assign has_child = false %}
                {% for subindicator in group.items %}
                    {% if subindicator.target_id == indicator.number %}
                        {% assign has_child = true %}
                        {% break %}
                    {% endif %}
                {% endfor %}

                {% if has_child == true %}
                    <!-- Si tiene hijos mostramos el hijo sin enlace y luego mostramos todos sus hijos -->
                    <div class="col-md-6 {{ tag_classes }} goal-indicator">
                        <span>
                            {{ indicator.number }}
                            <span class="status {{ status_css }}">
                                {{ status_desc }}
                            </span>
                        </span>
                        <p>{{ indicator.name }}</p>
                        {% if indicator.tags %}
                            <ul class="tags">
                                {% for tag in indicator.tags %}
                                    {% assign tag_class = tag | slugify %}
                                    <li class="tag-{{ tag_class }} warning">{{ tag | t }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    <!-- Mostramos todos los hijos del indicador en el que nos encontramos -->
                    {% for subindicator in group.items %}
                        {% if subindicator.target_id == indicator.number %}
                            {% assign status_css = subindicator.reporting_status | slugify %}
                            {% if subindicator.reporting_status == 'notapplicable' %}
                                {% assign status_desc = page.t.status.not_applicable %}
                            {% endif %}
                            {% if subindicator.reporting_status == 'notstarted' %}
                                {% assign status_desc = page.t.status.exploring_data_sources %}
                            {% endif %}
                            {% if subindicator.reporting_status == 'inprogress' %}
                                {% assign status_desc = page.t.status.statistics_in_progress %}
                            {% endif %}
                            {% if subindicator.reporting_status == 'complete' %}
                                {% assign status_desc = page.t.status.reported_online %}
                            {% endif %}
                            {% assign tag_classes = "" | split: "," %}
                            {% if subindicator.tags %}
                                {% for tag in subindicator.tags %}
                                    {% assign tag_slug = "subindicator-" | append: tag | slugify %}
                                    {% assign tag_classes = tag_classes | push: tag_slug %}
                                {% endfor %}
                            {% endif %}
                            {% assign tag_classes = tag_classes | join: " " %}

                            <div class="col-md-6 {{ tag_classes }} goal-indicator">
                                <span>
                                    {{ subindicator.number }}
                                    <span class="status {{ status_css }}">
                                        {{ status_desc }}
                                    </span>
                                </span>
                                <a href="{{ subindicator.url }}">
                                    {{ subindicator.name }}
                                </a>
                                {% if subindicator.tags %}
                                    <ul class="tags">
                                        {% for tag in subindicator.tags %}
                                            {% assign tag_class = tag | slugify %}
                                            <li class="tag-{{ tag_class }} warning">{{ tag | t }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <!-- Comprobamos que el padre sea un Goal, en ese caso lo imprimos normalemente. -->
                    <!-- Esto se hace para evitar que aparezcan nodos hoja duplicados. -->
                    <!-- <= 2 ya que el máximo número de un objetivo será de la forma X.Y siendo X e Y caracteres alfanuméricos. -->
                    {% assign indicator_level = indicator.target_id | split: '.' %}
                    {% if indicator_level.size <= 2 %} 
                        {% assign status_css = indicator.reporting_status | slugify %}
                        {% if indicator.reporting_status == 'notapplicable' %}
                            {% assign status_desc = page.t.status.not_applicable %}
                        {% endif %}
                        {% if indicator.reporting_status == 'notstarted' %}
                            {% assign status_desc = page.t.status.exploring_data_sources %}
                        {% endif %}
                        {% if indicator.reporting_status == 'inprogress' %}
                            {% assign status_desc = page.t.status.statistics_in_progress %}
                        {% endif %}
                        {% if indicator.reporting_status == 'complete' %}
                            {% assign status_desc = page.t.status.reported_online %}
                        {% endif %}
                        {% assign tag_classes = "" | split: "," %}
                        {% if indicator.tags %}
                            {% for tag in indicator.tags %}
                                {% assign tag_slug = "indicator-" | append: tag | slugify %}
                                {% assign tag_classes = tag_classes | push: tag_slug %}
                            {% endfor %}
                        {% endif %}
                        {% assign tag_classes = tag_classes | join: " " %}

                        <div class="col-md-12 {{ tag_classes }} goal-indicator">
                            <span>
                                {{ indicator.number }}
                                <span class="status {{ status_css }}">
                                    {{ status_desc }}
                                </span>
                            </span>
                            <a href="{{ indicator.url }}">
                                {{ indicator.name }}
                            </a>
                            {% if indicator.tags %}
                                <ul class="tags">
                                    {% for tag in indicator.tags %}
                                        {% assign tag_class = tag | slugify %}
                                        <li class="tag-{{ tag_class }} warning">{{ tag | t }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
    {% endfor %}
</div>

{% include footer.html %}
